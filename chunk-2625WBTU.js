import{L as m,g as i}from"./chunk-2SFP4N2H.js";import{a as o,b as n}from"./chunk-EQDQRRRY.js";var u=class c{storageKey="cart_v1";cartItems=[];cartTotalSource=new i(0);cartTotal$=this.cartTotalSource.asObservable();cartCountSource=new i(0);cartCount$=this.cartCountSource.asObservable();stockLimitSource=new i(null);stockLimit$=this.stockLimitSource.asObservable();constructor(){this.loadFromStorage(),this.refresh()}loadFromStorage(){let e=localStorage.getItem(this.storageKey);if(!e){this.cartItems=[];return}try{let t=JSON.parse(e);if(!Array.isArray(t)){console.warn("Cart data corrupted. Clearing."),this.cartItems=[];return}this.cartItems=t.map(r=>n(o({},r),{cartQuantity:r.cartQuantity??1,image:r.image??(Array.isArray(r.product_images)?r.product_images[0]:r.product_images)}))}catch(t){console.error("Failed to load cart:",t),this.cartItems=[]}}persist(){localStorage.setItem(this.storageKey,JSON.stringify(this.cartItems))}refresh(){let e=this.cartItems.reduce((r,s)=>r+(s.cartQuantity||0),0),t=this.cartItems.reduce((r,s)=>r+s.price*(s.cartQuantity||0),0);this.cartCountSource.next(e),this.cartTotalSource.next(t),this.persist()}getCartItems(){return this.cartItems}getQuantity(e){let t=this.cartItems.find(r=>r.id===e);return t&&t.cartQuantity||0}isInCart(e){return this.cartItems.some(t=>t.id===e)}addToCart(e){let t=this.cartItems.find(s=>s.id===e.id),r=e.stock??1;if(t){let s=(t.cartQuantity||0)+1;if(s>(t.stock??r)){let a=`Only ${t.stock??r} of "${t.name}" available.`;return this.stockLimitSource.next({productId:t.id,message:a}),{success:!1,message:a}}t.cartQuantity=s}else{let s=n(o({},e),{image:e.image??(Array.isArray(e.product_images)?e.product_images[0]:e.product_images),cartQuantity:1});this.cartItems.push(s)}return this.refresh(),{success:!0}}updateQuantity(e,t){let r=this.cartItems.find(a=>a.id===e);if(!r)return{success:!1,message:"Item not found"};let s=r.stock??1;if(t>s){r.cartQuantity=s,this.refresh();let a=`Only ${s} of "${r.name}" available.`;return this.stockLimitSource.next({productId:e,message:a}),{success:!1,message:a}}return t<1?(this.removeFromCart(e),{success:!0,message:"Item removed from cart"}):(r.cartQuantity=t,this.refresh(),{success:!0})}removeFromCart(e){this.cartItems=this.cartItems.filter(t=>t.id!==e),this.refresh()}clearCart(){this.cartItems=[],this.refresh()}getSubtotal(){return this.cartItems.reduce((e,t)=>e+t.price*(t.cartQuantity||0),0)}static \u0275fac=function(t){return new(t||c)};static \u0275prov=m({token:c,factory:c.\u0275fac,providedIn:"root"})};export{u as a};
